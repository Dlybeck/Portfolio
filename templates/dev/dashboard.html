<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dev Dashboard - Claude Code</title>

    <!-- External CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />

    <!-- Custom CSS (Modular!) -->
    <link rel="stylesheet" href="/static/dev/css/variables.css">
    <link rel="stylesheet" href="/static/dev/css/dashboard.css">
    <link rel="stylesheet" href="/static/dev/css/toolbar.css">
    <link rel="stylesheet" href="/static/dev/css/mobile.css">
    <link rel="stylesheet" href="/static/dev/css/desktop.css">
    <link rel="stylesheet" href="/static/dev/css/debug-panel.css">

    <!-- External JS -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
</head>

<body
    x-data
    x-init="$store.dashboard.init()"
    :data-view="$store.dashboard.currentView"
    :class="$store.dashboard.theme === 'light' ? 'light-theme' : ''"
>
    <!-- Header -->
    <header class="header">
        <h1 class="hide-mobile">🤖 Claude Code Terminal</h1>

        <div class="header-right">
            <button class="icon-btn hide-mobile" @click="$store.dashboard.decreaseFontSize()" title="Decrease font size">A-</button>
            <button class="icon-btn hide-mobile" @click="$store.dashboard.increaseFontSize()" title="Increase font size">A+</button>

            <button class="icon-btn" @click="$store.dashboard.toggleTheme()" title="Toggle theme">
                <span x-text="$store.dashboard.theme === 'light' ? '☀️' : '🌙'"></span>
            </button>

            <button class="icon-btn" @click="$store.dashboard.toggleSound()" title="Toggle notification sound">
                <span x-text="$store.dashboard.soundEnabled ? '🔔' : '🔕'"></span>
            </button>

            <span class="connection-status">
                <span
                    class="status-dot"
                    :class="{
                        'connected': $store.dashboard.wsConnected,
                        'disconnected': !$store.dashboard.wsConnected && !$store.dashboard.wsReconnecting,
                        'reconnecting': $store.dashboard.wsReconnecting
                    }"
                ></span>
                <span class="hide-mobile" x-text="
                    $store.dashboard.wsConnected ? 'Connected' :
                    $store.dashboard.wsReconnecting ? 'Reconnecting...' :
                    'Disconnected'
                "></span>
            </span>

            <span class="hide-mobile">👤 {{ user.username }}</span>
            <button class="btn-logout" @click="killSession()" style="background: #dc3545; margin-right: 8px;" title="Kill stuck session & restart">💀</button>
            <button class="btn-logout" @click="changeDirectory()" style="background: #667eea; margin-right: 8px;">📁</button>
            <button class="btn-logout" @click="logout()">Logout</button>
        </div>
    </header>

    <!-- Connection Banner -->
    <div
        class="connection-banner"
        x-show="!$store.dashboard.wsConnected && !$store.dashboard.wsReconnecting"
        x-transition
        style="display: none;"
    >
        <span>Disconnected - <a href="#" @click="location.reload()" style="color: #000; text-decoration: underline;">Click to reconnect</a></span>
    </div>

    <!-- Mobile Swipeable Keyboard Shortcuts Toolbar -->
    <div class="swipe-toolbar" x-data="toolbarHandler()">
        <div
            class="swipe-container"
            :style="`transform: translateX(-${$store.dashboard.toolbarPage * 50}%)`"
        >
            <!-- Page 1: Claude & Control Keys -->
            <div class="swipe-page">
                <button class="shortcut-btn" @click="sendKey('Tab')" title="Tab - Auto-complete">
                    <span class="btn-icon">⇥</span>
                    <span class="btn-label">Tab</span>
                </button>
                <button class="shortcut-btn" @click="sendKey('S+Tab')" title="Shift+Tab - Toggle Claude mode">
                    <span class="btn-icon">🔄</span>
                    <span class="btn-label">S+Tab</span>
                </button>
                <button class="shortcut-btn" @click="sendKey('^C')" title="Ctrl+C - Cancel">
                    <span class="btn-icon">⛔</span>
                    <span class="btn-label">^C</span>
                </button>
                <button class="shortcut-btn" @click="copyTerminal()" title="Copy selected text">
                    <span class="btn-icon">📋</span>
                    <span class="btn-label">Copy</span>
                </button>
            </div>

            <!-- Page 2: Arrow Keys -->
            <div class="swipe-page">
                <div class="arrow-row">
                    <button class="shortcut-btn" @click="sendKey('←')" title="Left Arrow">
                        <span class="btn-icon">←</span>
                    </button>
                    <button class="shortcut-btn" @click="sendKey('↑')" title="Up Arrow">
                        <span class="btn-icon">↑</span>
                    </button>
                    <button class="shortcut-btn" @click="sendKey('↓')" title="Down Arrow">
                        <span class="btn-icon">↓</span>
                    </button>
                    <button class="shortcut-btn" @click="sendKey('→')" title="Right Arrow">
                        <span class="btn-icon">→</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Page Indicators -->
        <div class="page-indicators">
            <template x-for="page in [0, 1]" :key="page">
                <span
                    class="page-dot"
                    :class="page === $store.dashboard.toolbarPage ? 'active' : ''"
                    @click="$store.dashboard.setToolbarPage(page)"
                ></span>
            </template>
        </div>
    </div>

    <!-- Main Container with Swipe Gestures -->
    <main
        class="main-container"
        x-data="swipeHandler()"
        @touchstart="onTouchStart"
        @touchmove="onTouchMove"
        @touchend="onTouchEnd"
    >
        <!-- Swipe Hint (fades after 3 seconds) -->
        <div
            class="swipe-hint"
            x-data="{ show: true }"
            x-show="show"
            x-init="setTimeout(() => show = false, 3000)"
            x-transition
        >
            ← Swipe →
        </div>

        <!-- Terminal Section -->
        <section class="terminal-section">
            <div class="terminal-header">
                Claude Code Session
            </div>
            <div class="terminal-container">
                <div id="terminal"></div>
            </div>
        </section>

        <!-- Preview Section -->
        <section class="preview-section">
            <div class="preview-tabs" x-data="{ activeTab: 'files' }">
                <div
                    class="tab"
                    :class="activeTab === 'files' ? 'active' : ''"
                    @click="activeTab = 'files'; switchTab('files')"
                >Files</div>
                <div
                    class="tab"
                    :class="activeTab === 'terminal' ? 'active' : ''"
                    @click="activeTab = 'terminal'; switchTab('terminal')"
                >Terminal</div>
                <div
                    class="tab"
                    :class="activeTab === 'preview' ? 'active' : ''"
                    @click="activeTab = 'preview'; switchTab('preview')"
                >Preview</div>
                <div
                    class="tab"
                    :class="activeTab === 'logs' ? 'active' : ''"
                    @click="activeTab = 'logs'; switchTab('logs')"
                >Logs</div>
            </div>

            <div class="tab-content" id="tabContent">
                <div class="placeholder">
                    Preview will appear here when Claude generates HTML, images, or other viewable content...
                </div>
            </div>
        </section>
    </main>

    <!-- Debug Panel (Mobile Only) -->
    <div x-show="window.innerWidth <= 768" class="debug-toggle-btn" @click="$store.debugPanel.toggle()">
        🐛
    </div>

    <!-- Debug Panel Overlay -->
    <div x-show="$store.debugPanel.visible"
         x-transition
         class="debug-panel-overlay"
         @click.self="$store.debugPanel.visible = false">
        <div class="debug-panel">
            <div class="debug-panel-header">
                <h3>🐛 Debug Panel</h3>
                <div>
                    <button @click="$store.debugPanel.fetchSessions()" class="debug-btn">🗂️ Sessions</button>
                    <button @click="$store.debugPanel.clear()" class="debug-btn">🧹 Clear</button>
                    <button @click="$store.debugPanel.visible = false" class="debug-btn">✖️ Close</button>
                </div>
            </div>
            <div class="debug-panel-content">
                <template x-for="log in $store.debugPanel.logs" :key="log">
                    <div class="debug-log-entry" x-text="log"></div>
                </template>
                <div x-show="$store.debugPanel.logs.length === 0" class="debug-empty">
                    No logs yet. Interact with the page to see debug output.
                </div>
            </div>
        </div>
    </div>

    <!-- Alpine Store (Load First!) -->
    <script src="/static/dev/js/alpine-store.js"></script>

    <!-- Application Modules -->
    <script src="/static/dev/js/terminal.js"></script>
    <script src="/static/dev/js/websocket.js"></script>
    <script src="/static/dev/js/gestures.js"></script>
    <script src="/static/dev/js/tabs.js"></script>

    <!-- Initialization -->
    <script>
        // Initialize terminal and connect WebSocket on page load
        document.addEventListener('DOMContentLoaded', () => {
            initTerminal();
            connectWebSocket();
            // Load files tab by default
            switchTab('files');
        });
    </script>
</body>
</html>
